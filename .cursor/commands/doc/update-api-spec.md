## /update-api-spec

このスラッシュコマンドは、`apps/backend` で実装済みの API をもとに `docs/api/api-spec.md` を最新化し、未実装のエンドポイントにマークを付与 / 解除します。

### ゴール

- **バックエンド（Gin）のルーティング定義**と**API仕様書（`docs/api/api-spec.md`）**を同期する。
- **未実装の API は仕様書から削除せず**、見出しに **未実装マーク** を付ける。
- **未実装マークが付いているエンドポイントが実装済みになった場合は、そのマークを自動で外す。**
- **パラメータ定義/レスポンス例が実装と異なる場合、実装を最新として仕様書を修正する。**
- **仕様書に存在しないが実装済みの API がある場合、仕様書に追記する（削除はしない）。**

### 前提

- バックエンドのルーティングは `apps/backend/src/router/router.go` に集約されている。
- Gin でのルーティングは、主に以下のような形式で記述されている想定。
  - `r.GET("/health", ...)`
  - `api := r.Group("/api/v1")`
  - `api.GET("/tags", ...)`
  - `authGroup := api.Group("/")`
  - `authGroup.POST("/tags", ...)`
- API 仕様書内のエンドポイント見出しは、次のような形式を基本とする。
  - `#### 4.1 GET /api/v1/me`
  - `#### 5.1 GET /api/v1/tags`
  - 未実装マーク付きの例（このコマンドで付与 / 解除する形式）:
    - `#### 4.1 GET /api/v1/me **[未実装]**`
- スクリプトを作成するのではなく、`docs/api/api-spec.md`を修正する。

### 未実装マークのルール

- **マークの文字列**: `**[未実装]**`
- **付与場所**: エンドポイント見出し行の末尾に半角スペースを挟んで付与する。
  - 例: `#### 4.1 GET /api/v1/me **[未実装]**`
- **このコマンドの責務**
  - 仕様書内の各エンドポイント見出しを走査し、`HTTPメソッド + パス` の組み合わせでバックエンド実装と突き合わせる。
  - バックエンドに存在しないもの: 見出し末尾に `**[未実装]**` を付与（既にあればそのまま）。
  - バックエンドに存在するもの: 見出し行から `**[未実装]**` を削除。
  - 仕様書内の **パラメータ**・**レスポンス例** が実装と差分がある場合、**実装を最新**として仕様書を更新する。
  - 仕様書に存在しないが実装済みのエンドポイントがある場合、仕様書に **新規セクションとして追加**する。

### 実装方針（このコマンド実行時に行う処理）

1. **バックエンドのルーティング定義から実装済みエンドポイント一覧を取得する**
   - `apps/backend/src/router/router.go` を読み込む。
   - 簡易パーサーとして、テキストベースで以下を行う。
     - `r := gin.Default()` のようなルートエンジン変数（例: `r`）をルートとみなす（プレフィックスは空文字）。
     - `api := r.Group("/api/v1")` のような `XXX := <親>.Group("prefix")` を検出し、変数名と URL プレフィックスの対応をマッピングする。
       - 親グループにプレフィックスがある場合は結合する（例: `api` のプレフィックス `/api/v1`、`authGroup := api.Group("/")` → `/api/v1/`）。
     - 上記で得た各グループ変数に対して、
       - `<group>.GET("path", ...)`
       - `<group>.POST("path", ...)`
       - `<group>.PATCH("path", ...)`
       - `<group>.PUT("path", ...)`
       - `<group>.DELETE("path", ...)`
       - などを正規表現で検出する。
     - それぞれについて、`prefix + path` を連結し、`METHOD` と `パス` のペアとして「実装済みエンドポイント集合」を構築する。
       - 例: `api := r.Group("/api/v1")` + `api.GET("/tags", ...)` → `("GET", "/api/v1/tags")`
       - 例: `r.GET("/health", ...)` → `("GET", "/health")`
   - ルーティング取得はテキスト解析レベルに留め、DB などの実行時依存関係には触れない（`router.NewRouter()` を実行しない）。

2. **仕様書 `docs/api/api-spec.md` を解析し、各エンドポイントを特定する**
   - `docs/api/api-spec.md` を読み込む。
   - 各行を走査し、以下の形式の見出し行を対象とする。
     - `#### 任意の番号 METHOD \`/path\`` （末尾に `**[未実装]**` が付いている場合も含む）
   - 正規表現のイメージ:
     - `^####\\s+[^\\s]+\\s+(GET|POST|PUT|PATCH|DELETE)\\s+\\\`([^\\\`]+)\\\`(\\s+\\*\\*\\[未実装]\\*\\*)?$`
   - 上記の正規表現で、以下を抽出する。
     - `method`: `GET` / `POST` / `PUT` / `PATCH` / `DELETE`
     - `path`: バッククォート内のパス（例: `/api/v1/tags`）
     - `hasUnimplementedMark`: 末尾に `**[未実装]**` が既に付いているかどうか。

3. **バックエンド実装との突き合わせとマーク付けロジック**
   - 手順 1 で得た「実装済みエンドポイント集合」を `implementedSet` とする。
   - 手順 2 で得た各見出し行に対して、次を行う。
     - `key = method + " " + path` を作る（例: `"GET /api/v1/tags"`）。
     - `key` が `implementedSet` に **含まれている** 場合:
       - 見出し行から `**[未実装]**` を取り除く（マークが無ければ変更なし）。
     - `key` が `implementedSet` に **含まれていない** 場合:
       - 見出し行末尾に `**[未実装]**` を付与する（既に付いていればそのまま）。
   - この処理では、仕様書からどのエンドポイントも削除しない（行の追加・削除は行わず、「未実装マーク」の有無だけを変更する）。

4. **（追加）実装を正として、パラメータ/レスポンス例を最新化する**
   - 実装済みエンドポイント（`implementedSet` に存在）について、仕様書内の以下が実装と一致しているか確認する。
     - リクエストパラメータ（Path / Query / Body の各フィールド名・型・必須/任意・制約）
     - レスポンス構造（フィールド名・型・ネスト構造）
     - レスポンス例（例示のJSONの形、nullability、配列要素など）
   - 差分がある場合は **実装を最新**として、`docs/api/api-spec.md` を修正する。
   - 参照元（実装）としては、基本的に以下を優先する。
     - `apps/backend/src/router/router.go`（ルーティング）
     - 対応する `internal/handler/`（入出力のDTO/バインド/レスポンス）
     - `internal/service/` / `internal/model/`（ドメイン構造）
   - 注意: 仕様書側のフィールド名は、実装のJSONタグ（`json:"..."`）に合わせる。

5. **（追加）仕様書に存在しない実装済みAPIを追記する**
   - 手順1で得た「実装済みエンドポイント集合」から、手順2で抽出できなかった（= 仕様書に見出しが無い）ものを洗い出す。
   - 見つかった場合は、`docs/api/api-spec.md` に **新規エンドポイントセクション**（見出し行＋概要＋パラメータ＋レスポンス＋例）として追記する。
   - 追記先は関連セクション（例: Tags / Movies / Auth など）に合わせ、番号（`#### 5.1` のような連番）も既存規則に合わせて整える。

6. **ファイルの更新**
   - 上記ロジックに従って更新した内容で `docs/api/api-spec.md` を上書きする。
   - 変更内容が分かりやすいように、必要に応じて `git diff` 相当の説明を簡潔にコメントで伝える。

7. **（任意）ドキュメントと実装の差分レポート**
   - 可能であれば、Chat内の出力として簡単なレポートを併せて提示する。
     - 例:
       - **実装されているが仕様書に存在しないエンドポイント**
       - **実装されているが仕様書のパラメータ/レスポンス例と差分があった箇所（今回修正したもの）**
       - **仕様書にあるが実装されていないエンドポイント（今回 [未実装] マークが付いたもの）**

### 実行時の注意

- ルーティングの検出は `apps/backend/src/router/router.go` のテキストベース解析に依存するため、将来ファイル構成や記述パターンが変わった場合は、このコマンドの説明を更新して対応する。
- マーク付けルールは **`**[未実装]**` のみ**を前提としているため、別の表現に変更したい場合はここを修正する。

