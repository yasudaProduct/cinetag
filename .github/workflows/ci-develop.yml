name: CI (develop)

on:
  push:
    branches:
      - develop

concurrency:
  group: ci-develop-${{ github.ref }} # ジョブの並行実行を防止するためのグループ名
  cancel-in-progress: true # 同じグループ内のジョブが実行中の場合、古いジョブをキャンセルする

jobs:
  # backend-unit-test は backend ディレクトリの単体テストを実行するジョブ
  backend-unit-test:
    name: backend / go test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: apps/backend/go.mod
          cache-dependency-path: apps/backend/go.sum

      - name: Run unit tests
        run: go test ./...

  # backend-vulncheck は backend の依存関係/コード利用状況に基づく既知脆弱性を検出するジョブ
  # 検出した場合は exit code 1 となり CI を失敗させる
  # backend-vulncheck:
  #   name: backend / govulncheck
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: apps/backend
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Setup Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version-file: apps/backend/go.mod
  #         cache-dependency-path: apps/backend/go.sum

  #     - name: Add Go bin to PATH
  #       run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

  #     - name: Install govulncheck
  #       run: go install golang.org/x/vuln/cmd/govulncheck@latest

  #     - name: Run govulncheck
  #       run: govulncheck ./...

  # frontend-dependency-audit は frontend の依存関係に既知脆弱性がある場合に CI を失敗させるジョブ
  # frontend-dependency-audit:
  #   name: frontend / npm audit
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: apps/frontend
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: "20"
  #         cache: "npm"
  #         cache-dependency-path: apps/frontend/package-lock.json

  #     - name: Install deps
  #       run: npm ci

  #     - name: Run npm audit
  #       run: npm audit --audit-level=low

  # backend-migrate は開発用Neonデータベースへのマイグレーションを実行するジョブ
  backend-migrate:
    name: backend / migrate (Neon)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: apps/backend/go.mod
          cache-dependency-path: apps/backend/go.sum

      - name: Run migration
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
          ENV: develop
        run: go run ./src/cmd/migrate

  # frontend-check は frontend ディレクトリの lint と build を実行するジョブ
#   frontend-check:
#     name: frontend / lint + build
#     runs-on: ubuntu-latest
#     defaults:
#       run:
#         working-directory: apps/frontend
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: "20"
#           cache: "npm"
#           cache-dependency-path: apps/frontend/package-lock.json

#       - name: Install deps
#         run: npm ci

#       - name: Lint
#         run: npm run lint

#       - name: Build
#         run: npm run build
